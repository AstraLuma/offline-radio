<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Radio</title>
    <style>
      body {
        display: grid;
        margin: 0.5rem;
        width: calc(100vw - 1rem);
        height: calc(100vh - 1rem);
        grid-template-columns: auto;
        grid-template-rows: 2rem 2rem 2rem auto;
        grid-template-areas: 
          "title"
          "player"
          "buttons"
          "desc"
      }
      #title {
        grid-area: title;
        white-space: nowrap;
        overflow: hidden;
        font-size: 1.5rem;
        margin-top: 0rem;
        margin-bottom: 0rem;
      }
      #player {
        grid-area: player;
        display: block;
        width: 100%;
        height: 2rem;
      }
      #button-bar {
        grid-area: buttons;
      }
      #desc {
        grid-area: desc;
        overflow: scroll;
        white-space: pre;
      }
    </style>
  </head>
  <body>
    <h1 id="title"></h1>
    <audio id="player" controls autoplay></audio>
    <div id="button-bar">
      <button id="next">Next</button>
    </div>
    <div id="desc"></div>
    <script>
function pyready() {
  return new Promise(function(resolve, reject) {
    window.addEventListener("pywebviewready", resolve);
  });
}

function domready() {
  return new Promise(function(resolve, reject) {
    document.addEventListener("DOMContentLoaded", resolve);
  });
}

Promise.all([
  pyready().then(() => {
    console.log("API ready");
    return pywebview.api.read_track_data();
  }),
  domready().then(() => ({
    player: document.getElementById('player'),
    title: document.getElementById('title'),
    desc: document.getElementById('desc'),
    next: document.getElementById('next'),
  }))
]).then((data) => {
  var tracks = data[0];
  var elems = data[1];

  function next_track() {
    var next = tracks[Math.floor(Math.random() * tracks.length)];
    console.log("Loading", next);
    pywebview.api.read_track_contents(next.filename).then((url) => {
      elems.title.innerText = next.title;
      elems.desc.innerText = next.desc;
      elems.player.src = url;
    });
  }

  elems.player.addEventListener('ended', next_track);
  elems.next.addEventListener('click', next_track);

  next_track();
});
    </script>
  </body>
</html>